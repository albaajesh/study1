<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.infotop.account.mapper.RoleMapper">
  <select id="getId" resultType="long">
  	SELECT max(id) FROM t_role
  </select>
  
  <select id="getRoles" parameterType="map" resultType="Role">
    SELECT
    	id,
    	name,
   		description
    FROM role
    <where>
    	<if test="id != null">
    		id = #{id}
    	</if>
    	<if test="name != null">
    		AND name = #{name}
    	</if>
    	<if test="description != null">
    		AND description = #{description}
    	</if>
    </where>
  </select>

  <select id="getRoleList" resultType="Role">
    SELECT
    	id,
    	name,
    	description
    FROM role
  </select>
  
  <select id="getRole" resultMap="roleResult">
    SELECT
    	r.id as role_id,
    	r.role_name,
   		r.description,
   		p.id as p_id,
   		p.per_name,
   		p.module,
   		p.privilege
    FROM role r
    LEFT JOIN role_permission rp ON(r.id=rp.role_id)
    LEFT JOIN permission p ON(p.id=rp.permission_id) where r.role_name=#{name}
  </select>
  
 <resultMap id="roleResult"  type="Role"> 
		<id property="id"  column="id" />
		<result property="name" column="role_name"/>
		<result property="description" column="description"/>
		<collection property="permissions"  ofType="Permission"> 
			<id property="id"  column="id"/> 
			<result property="name"  column="per_name"/>
			<result property="module"  column="module"/>
			<result property="privilege"  column="privilege"/>
		</collection> 
  </resultMap>
  
  <insert id="insertRole" parameterType="Role" >
  	INSERT INTO role (id,name,description)
    VALUES (#{id},#{name}, #{description})
  </insert>
  
  <insert id="insertRoleMenu" parameterType="map">
  	INSERT INTO menu_role (menu_id,role_id)
    VALUES (#{menu_id}, #{role_id})
  </insert>
  
  <update id="updateRole"  parameterType="Role"> 
	UPDATE role
	<set> 
		<if test="name != null">name=#{name},</if>
		<if test="description != null">description=#{description}</if>
	</set>
	WHERE id=#{id}
  </update>
  
  <update id="updateRoleMenu"  parameterType="map"> 
	UPDATE menu_role SET
	menu_id=#{menu_id}
	WHERE role_id=#{role_id}
  </update>
  
  <delete id="deleteRole"  parameterType="map">
  	DELETE FROM role WHERE id=#{id}
  </delete>
  
  <delete id="deleteRoleMenu"  parameterType="map">
  	DELETE FROM menu_role WHERE role_id=#{role_id}
  </delete>
  
</mapper>